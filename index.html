<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Surf Report | Capitola Beach</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="backdrop"></div>
    <main class="report">
      <header class="masthead">
        <div>
          <p class="eyebrow">Surf @ Report</p>
          <h1>Capitola Beach · Capitola, CA</h1>
          <p class="subtitle">Live conditions pulled from Open-Meteo + RapidAPI tides</p>
        </div>
        <button id="refresh" class="ghost">Refresh data</button>
      </header>

      <section class="card glass">
        <div class="card-top">
          <div>
            <p class="label">Now</p>
            <div class="temp-row">
              <div id="temperature" class="temp">—</div>
              <div>
                <div class="condition" id="condition">Loading conditions…</div>
                <div class="muted" id="wind">Wind —</div>
              </div>
            </div>
          </div>
          <div class="sun-times">
            <div>
              <p class="label">Sunrise</p>
              <p id="sunrise">—</p>
            </div>
            <div>
              <p class="label">Sunset</p>
              <p id="sunset">—</p>
            </div>
            <div>
              <p class="label">UV Max</p>
              <p id="uv">—</p>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid">
          <article class="stat">
            <p class="label">Primary Wave</p>
            <h3 id="primary-wave">—</h3>
            <p class="muted" id="primary-period">Height · Direction · Period</p>
          </article>
          <article class="stat">
            <p class="label">Water Temp</p>
            <h3 id="water-temp">—</h3>
            <p class="muted">Marine model sea surface temp</p>
          </article>
          <article class="stat">
            <p class="label">Next Tide</p>
            <h3 id="next-tide">—</h3>
            <p class="muted" id="tide-meta">Capitola tide extremes</p>
          </article>
          <article class="stat">
            <p class="label">Day Outlook</p>
            <h3 id="day-outlook">—</h3>
            <p class="muted">Morning · Afternoon · Evening waves</p>
          </article>
        </div>

        <div class="mini-grid" id="timeline">
          <div class="mini-card">
            <p class="label">Morning</p>
            <p id="wave-morning">—</p>
          </div>
          <div class="mini-card">
            <p class="label">Midday</p>
            <p id="wave-mid">—</p>
          </div>
          <div class="mini-card">
            <p class="label">Evening</p>
            <p id="wave-eve">—</p>
          </div>
          <div class="mini-card">
            <p class="label">Marine API</p>
            <p id="marine-status">Pending…</p>
          </div>
          <div class="mini-card">
            <p class="label">Forecast API</p>
            <p id="forecast-status">Pending…</p>
          </div>
          <div class="mini-card">
            <p class="label">RapidAPI Tides</p>
            <p id="tide-status">Pending…</p>
          </div>
        </div>
      </section>
    </main>

    <script>
      const spot = {
        name: "Capitola Beach",
        city: "Capitola",
        latitude: 36.972,
        longitude: -122.026,
        timezone: "America/Los_Angeles",
      };

      const tideApiKey =
        window.TIDES_API_KEY || localStorage.getItem("tideApiKey") || "";
      const tideApiHost = "tides.p.rapidapi.com";

      const conditionMap = {
        0: "Clear sky",
        1: "Mostly clear",
        2: "Partly cloudy",
        3: "Overcast",
        45: "Foggy",
        48: "Foggy",
        51: "Drizzle",
        61: "Light rain",
        80: "Showers",
        95: "Thunderstorms",
      };

      const dom = (id) => document.getElementById(id);

      function formatTime(value) {
        if (!value) return "—";
        const date = new Date(value);
        return date.toLocaleTimeString([], {
          hour: "numeric",
          minute: "2-digit",
        });
      }

      function status(id, text, ok = true) {
        dom(id).textContent = ok ? `✅ ${text}` : `❌ ${text}`;
      }

      async function fetchForecast() {
        const params = new URLSearchParams({
          latitude: spot.latitude,
          longitude: spot.longitude,
          current_weather: "true",
          hourly: [
            "temperature_2m",
            "apparent_temperature",
            "windspeed_10m",
            "winddirection_10m",
            "uv_index",
          ].join(","),
          daily: ["sunrise", "sunset", "uv_index_max"].join(","),
          timezone: spot.timezone,
        });

        const res = await fetch(`https://api.open-meteo.com/v1/forecast?${params}`);
        if (!res.ok) throw new Error("Forecast API failed");
        const data = await res.json();
        return data;
      }

      async function fetchMarine() {
        const params = new URLSearchParams({
          latitude: spot.latitude,
          longitude: spot.longitude,
          hourly: [
            "wave_height",
            "wave_direction",
            "wave_period",
            "wind_wave_height",
            "wind_wave_direction",
            "wind_wave_period",
            "water_temperature",
          ].join(","),
          timezone: spot.timezone,
        });

        const res = await fetch(`https://marine-api.open-meteo.com/v1/marine?${params}`);
        if (!res.ok) throw new Error("Marine API failed");
        return res.json();
      }

      async function fetchTides() {
        if (!tideApiKey) {
          throw new Error("RapidAPI tide key missing");
        }

        const params = new URLSearchParams({
          latitude: spot.latitude,
          longitude: spot.longitude,
          interval: 60,
          duration: 72,
        });
        const res = await fetch(`https://${tideApiHost}/tides?${params}`, {
          headers: {
            "X-RapidAPI-Key": tideApiKey,
            "X-RapidAPI-Host": tideApiHost,
          },
        });
        if (!res.ok) throw new Error("RapidAPI tide API failed");
        const data = await res.json();
        if (!data.extremes) throw new Error("Unexpected tide response");
        return data;
      }

      function windText(current) {
        const speed = current.windspeed;
        const dir = Math.round(current.winddirection);
        return `${Math.round(speed)} mph · ${dir}°`;
      }

      function waveSummary(marine, targetHour) {
        const times = marine.hourly.time.map((t) => new Date(t));
        const now = new Date();
        const target = new Date(now);
        target.setHours(targetHour, 0, 0, 0);
        const idx = times.findIndex((t) => t >= target);
        if (idx === -1) return "—";
        const h = marine.hourly.wave_height[idx];
        const p = marine.hourly.wave_period[idx];
        return `${h.toFixed(1)} ft @ ${p.toFixed(0)} s`;
      }

      function nextTide(extremes) {
        const now = new Date();
        const parsed = extremes
          .map((p) => ({
            time: new Date(p.dt || p.t),
            type: p.type,
            height: p.height ?? p.v,
          }))
          .sort((a, b) => a.time - b.time);
        const next = parsed.find((p) => p.time > now);
        if (!next) return null;
        return next;
      }

      async function load() {
        try {
          const [forecast, marine, tides] = await Promise.all([
            fetchForecast(),
            fetchMarine(),
            fetchTides(),
          ]);

          const current = forecast.current_weather;
          dom("temperature").textContent = `${Math.round(current.temperature)}°`;
          dom("condition").textContent = conditionMap[current.weathercode] || "Clear";
          dom("wind").textContent = windText(current);
          dom("sunrise").textContent = formatTime(forecast.daily.sunrise[0]);
          dom("sunset").textContent = formatTime(forecast.daily.sunset[0]);
          dom("uv").textContent = `${forecast.daily.uv_index_max[0].toFixed(1)}`;
          status("forecast-status", "Open-Meteo forecast loaded");

          const height = marine.hourly.wave_height[0];
          const direction = marine.hourly.wave_direction[0];
          const period = marine.hourly.wave_period[0];
          dom("primary-wave").textContent = `${height.toFixed(1)} ft`;
          dom(
            "primary-period"
          ).textContent = `${direction.toFixed(0)}° · ${period.toFixed(0)} s`;
          dom("water-temp").textContent = `${marine.hourly.water_temperature[0].toFixed(1)}°F`;
          dom("wave-morning").textContent = waveSummary(marine, 8);
          dom("wave-mid").textContent = waveSummary(marine, 12);
          dom("wave-eve").textContent = waveSummary(marine, 18);
          dom("day-outlook").textContent = `${marine.hourly.wave_height[0].toFixed(
            1
          )}–${Math.max(
            marine.hourly.wave_height[6] || marine.hourly.wave_height[0],
            marine.hourly.wave_height[12] || marine.hourly.wave_height[0]
          ).toFixed(1)} ft`;
          status("marine-status", "Marine API loaded");

          const tide = nextTide(tides.extremes);
          if (tide) {
            const label = tide.type === "H" ? "High" : "Low";
            dom("next-tide").textContent = `${label} ${tide.height.toFixed(
              2
            )} ft @ ${formatTime(
              tide.time
            )}`;
            dom("tide-meta").textContent = `Upcoming tides: ${tides.extremes
              .slice(0, 4)
              .map((p) => `${p.type} ${formatTime(p.dt || p.t)}`)
              .join(" · ")}`;
            status("tide-status", "RapidAPI tide data loaded");
          } else {
            status("tide-status", "No tide entries", false);
          }
        } catch (error) {
          console.error(error);
          status("forecast-status", "Forecast error", false);
          status("marine-status", "Marine error", false);
          status("tide-status", "Tide error", false);
        }
      }

      dom("refresh").addEventListener("click", load);
      load();
    </script>
  </body>
</html>
