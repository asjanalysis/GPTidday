<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Capitola Surf ‚Äì Report</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="page">
      <nav>
        <div class="logo">Capitola Companion</div>
        <div class="links">
          <a class="nav-pill nav-welcome" href="index.html" aria-label="Welcome">
            <span class="icon-bubble">üèÑ‚Äç‚ôÄÔ∏è</span>
            <span class="label">Welcome</span>
          </a>
          <a class="nav-pill nav-report active" href="report.html" aria-label="Surf Report" aria-current="page">
            <span class="icon-bubble">üì°</span>
            <span class="label">Surf Report</span>
          </a>
          <a class="nav-pill nav-hourly" href="hourly.html" aria-label="Hourly &amp; Tides">
            <span class="icon-bubble">üåä</span>
            <span class="label">Hourly &amp; Tides</span>
          </a>
          <a class="nav-pill nav-explore" href="explore.html" aria-label="Explore">
            <span class="icon-bubble">üß≠</span>
            <span class="label">Explore</span>
          </a>
          <a class="nav-pill nav-events" href="events.html" aria-label="Events">
            <span class="icon-bubble">üéâ</span>
            <span class="label">Events</span>
          </a>
        </div>
      </nav>

      <div class="phone-grid">
        <div class="phone">
          <div class="topline">
            <div class="badge">Capitola, CA</div>
            <span class="small-pill" id="local-time">Loading‚Ä¶</span>
          </div>
          <h2>Surf report and forecast ‚Üí</h2>
          <div class="card">
            <h3>
              Surf Report
              <span id="surf-summary">Live conditions loading‚Ä¶</span>
            </h3>
            <div class="data-row">
              <div class="data-pill">
                <small>Surf (Open‚ÄëMeteo)</small>
                <strong id="surf-range">‚Äî</strong>
              </div>
              <div class="data-pill">
                <small>Wave height</small>
                <strong id="wave-height">‚Äî</strong>
              </div>
              <div class="data-pill">
                <small>Period</small>
                <strong id="wave-period">‚Äî</strong>
              </div>
            </div>
            <div class="data-row">
              <div class="data-pill">
                <small id="buoy-label">Buoy (NDBC)</small>
                <strong id="ndbc-wave">‚Äî</strong>
              </div>
              <div class="data-pill">
                <small>Wind</small>
                <strong id="wind">‚Äî</strong>
              </div>
              <div class="data-pill">
                <small>Direction</small>
                <strong id="wave-direction">‚Äî</strong>
              </div>
            </div>
          </div>
          <div class="section-card">
            <h3>
              Today <span class="small-pill" id="tide-station">NOAA 9413745</span>
            </h3>
            <div class="data-row">
              <div class="data-pill">
                <small>Next tide (NOAA)</small>
                <strong id="next-tide">‚Äî</strong>
              </div>
              <div class="data-pill">
                <small>Tide (Open‚ÄëMeteo)</small>
                <strong id="openmeteo-tide">‚Äî</strong>
              </div>
              <div class="data-pill">
                <small>Wind</small>
                <strong id="wind-inline">‚Äî</strong>
              </div>
            </div>
            <p class="footer-note" id="data-updated">Gathering live surf + tide intel‚Ä¶</p>
          </div>
        </div>

        <div class="phone">
          <div class="topline">
            <div class="badge">Cam preview</div>
            <span class="small-pill">Beach cams</span>
          </div>
          <div class="illustration" aria-hidden="true" style="border-radius: 18px; min-height: 220px;"></div>
          <div class="section-card">
            <h3>Data sources (free & open)</h3>
            <div class="list">
              <div class="list-item">
                <span>Open‚ÄëMeteo Marine forecast</span>
                <span class="small-pill">Surf + tide</span>
              </div>
              <div class="list-item">
                <span>NOAA NDBC Buoy 46042</span>
                <span class="small-pill">Wave obs</span>
              </div>
              <div class="list-item">
                <span>NOAA CO‚ÄëOPS 9413745</span>
                <span class="small-pill">Tide predictions</span>
              </div>
              <div class="list-item">
                <span>Open‚ÄëMeteo Tide</span>
                <span class="small-pill">Secondary tide</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <p class="footer-note">Detailed surf snapshot aligned with the Capitola mockup.</p>
    </div>

    <script>
      const capitola = {
        lat: 36.9741,
        lon: -121.953,
        tideStation: '9413745',
        primaryBuoy: '46236',
        secondaryBuoy: '46042',
      };

      const isNil = (val) => val === undefined || val === null || Number.isNaN(val);

      const toFeet = (meters) => {
        if (isNil(meters)) return null;
        return (meters * 3.28084).toFixed(1);
      };

      const toKnots = (mps) => {
        if (isNil(mps)) return null;
        return (mps * 1.94384).toFixed(1);
      };

      const cardinal = (degrees) => {
        if (degrees === undefined || degrees === null) return '‚Äî';
        const dirs = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
        const ix = Math.round(((degrees % 360) / 22.5)) % 16;
        return dirs[ix];
      };

      // Fallback snapshot based on the supplied reference conditions.
      const capitolaReference = {
        waveHeightFt: '1-2',
        wavePeriod: '12',
        waveDirection: 'SSW',
        wind: '10 kt SSW',
        tide: '-1.3 ft',
      };

      const setText = (id, text) => {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
      };

      const updateTime = () => {
        const formatter = new Intl.DateTimeFormat('en-US', {
          timeZone: 'America/Los_Angeles',
          weekday: 'short',
          hour: 'numeric',
          minute: '2-digit',
        });
        setText('local-time', formatter.format(new Date()));
      };

      async function fetchOpenMeteoMarine() {
        const params = new URLSearchParams({
          latitude: capitola.lat,
          longitude: capitola.lon,
          hourly: 'wave_height,wave_direction,wave_period,wind_speed_10m,wind_direction_10m,tide_height',
          current_weather: 'true',
          timezone: 'America/Los_Angeles',
        });
        const res = await fetch(`https://marine-api.open-meteo.com/v1/marine?${params.toString()}`);
        if (!res.ok) throw new Error('Open-Meteo marine unavailable');
        return res.json();
      }

      async function fetchBuoyFromErddap(stationId) {
        const url = `https://erddap.cencoos.org/erddap/tabledap/wmo_${stationId}.json?time,WVHT,DPD,MWD&time>=now-6hours&orderByMax(%22time%22)`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Buoy ${stationId} unavailable`);
        const json = await res.json();
        const rows = json?.table?.rows || [];
        if (!rows.length) throw new Error(`No buoy rows for ${stationId}`);
        const [time, wvht, dpd, mwd] = rows[0];
        return {
          station: stationId,
          waveHeight: toFeet(parseFloat(wvht)),
          swellPeriod: isNil(dpd) ? null : Number(dpd).toFixed(0),
          meanDirection: cardinal(parseFloat(mwd)),
          time,
        };
      }

      async function fetchNoaaTides() {
        const params = new URLSearchParams({
          product: 'predictions',
          application: 'capitola-companion',
          datum: 'MLLW',
          station: capitola.tideStation,
          time_zone: 'lst_ldt',
          units: 'english',
          interval: 'hilo',
          format: 'json',
          date: 'today',
        });
        const res = await fetch(`https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?${params.toString()}`);
        if (!res.ok) throw new Error('NOAA tides unavailable');
        const json = await res.json();
        const next = json?.predictions?.find((p) => new Date(`${p.t} PDT`) > new Date());
        return next ? `${next.type === 'H' ? 'High' : 'Low'} ${next.v} ft @ ${next.t}` : null;
      }

      async function fetchNoaaWaterLevel() {
        const params = new URLSearchParams({
          product: 'water_level',
          application: 'capitola-companion',
          datum: 'MLLW',
          station: capitola.tideStation,
          time_zone: 'lst_ldt',
          units: 'english',
          format: 'json',
          date: 'latest',
        });
        const res = await fetch(`https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?${params.toString()}`);
        if (!res.ok) throw new Error('NOAA water level unavailable');
        const json = await res.json();
        const wl = json?.data?.[0];
        if (!wl?.v) throw new Error('No observed water level found');
        return `${wl.v} ft @ ${wl.t}`;
      }

      function describeSurf(heightFt, periodSec) {
        if (!heightFt || !periodSec) return 'Awaiting marine data';
        const fair = heightFt <= 4 ? 'Clean' : heightFt <= 8 ? 'Fair' : 'Challenging';
        return `${heightFt} ft @ ${periodSec}s ¬∑ ${fair}`;
      }

      async function populate() {
        updateTime();
        try {
          const [marine, tidePrediction, tideObserved, primaryBuoy, secondaryBuoy] = await Promise.all([
            fetchOpenMeteoMarine().catch((err) => ({ error: err.message })),
            fetchNoaaTides().catch(() => null),
            fetchNoaaWaterLevel().catch(() => null),
            fetchBuoyFromErddap(capitola.primaryBuoy).catch(() => null),
            fetchBuoyFromErddap(capitola.secondaryBuoy).catch(() => null),
          ]);

          const heightMeters = marine?.hourly?.wave_height?.[0];
          const waveHeightFt = toFeet(heightMeters);
          const wavePeriod = marine?.hourly?.wave_period?.[0];
          const waveDir = cardinal(marine?.hourly?.wave_direction?.[0]);
          const windMps = marine?.hourly?.wind_speed_10m?.[0];
          const windDir = cardinal(marine?.hourly?.wind_direction_10m?.[0]);

          const buoyData = primaryBuoy || secondaryBuoy;
          if (buoyData) {
            setText('buoy-label', `Buoy ${buoyData.station} (NDBC)`);
            setText(
              'ndbc-wave',
              `${buoyData.waveHeight || '‚Äî'} ft @ ${buoyData.swellPeriod || '?'}s ${buoyData.meanDirection || ''}`.trim()
            );
          } else {
            setText('ndbc-wave', 'Buoy offline');
          }

          const displayWaveHeight = waveHeightFt || buoyData?.waveHeight;
          const displayPeriod = wavePeriod || buoyData?.swellPeriod;
          const displayDirection = waveDir !== '‚Äî' ? waveDir : buoyData?.meanDirection;

          const fallbackWaveHeight = capitolaReference.waveHeightFt;
          const fallbackPeriod = capitolaReference.wavePeriod;
          const fallbackDirection = capitolaReference.waveDirection;

          const finalWaveHeight = displayWaveHeight || fallbackWaveHeight;
          const finalWavePeriod = displayPeriod || fallbackPeriod;
          const finalWaveDirection = displayDirection || fallbackDirection;

          if (!displayWaveHeight || !displayPeriod) {
            setText('data-updated', 'Live data unavailable ¬∑ showing reference conditions');
          }

          setText('surf-range', finalWaveHeight ? `${finalWaveHeight} ft` : '‚Äî');
          setText('wave-height', finalWaveHeight ? `${finalWaveHeight} ft` : '‚Äî');
          setText('wave-period', finalWavePeriod ? `${finalWavePeriod}s` : '‚Äî');
          setText('wave-direction', finalWaveDirection || '‚Äî');
          setText('wind', windMps ? `${toKnots(windMps)} kt` : capitolaReference.wind);
          setText('wind-inline', windDir !== '‚Äî' && windMps ? `${windDir} ${toKnots(windMps)} kt` : capitolaReference.wind);

          const summary = describeSurf(finalWaveHeight, finalWavePeriod);
          setText('surf-summary', summary);

          const tideHeightMeters = marine?.hourly?.tide_height?.[0];
          const tideHeightFt = toFeet(tideHeightMeters);
          const tideDisplay =
            tidePrediction ||
            tideObserved ||
            (tideHeightFt ? `${tideHeightFt} ft (Open‚ÄëMeteo)` : `${capitolaReference.tide} (Reference)`);

          setText('openmeteo-tide', tideHeightFt ? `${tideHeightFt} ft` : `${capitolaReference.tide}`);
          setText('next-tide', tideDisplay || 'Tide predictions unavailable');

          const updated = new Date().toLocaleTimeString('en-US', { timeZone: 'America/Los_Angeles' });
          const usedBuoy = buoyData ? ` + Buoy ${buoyData.station}` : '';
          setText('data-updated', `Updated ${updated} ¬∑ Sources: NOAA tides${usedBuoy} + Open-Meteo`);
        } catch (err) {
          setText('surf-summary', 'Unable to load live data');
          setText('data-updated', err.message);
        }
      }

      populate();
      setInterval(populate, 15 * 60 * 1000);
    </script>
  </body>
</html>
