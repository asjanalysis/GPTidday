<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Capitola Surf ‚Äì Report</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="page">
      <nav>
        <div class="logo">Capitola Companion</div>
        <div class="links">
          <a class="nav-pill nav-welcome" href="index.html" aria-label="Welcome">
            <span class="icon-bubble">üèÑ‚Äç‚ôÄÔ∏è</span>
            <span class="label">Welcome</span>
          </a>
          <a class="nav-pill nav-report active" href="report.html" aria-label="Surf Report" aria-current="page">
            <span class="icon-bubble">üì°</span>
            <span class="label">Surf Report</span>
          </a>
          <a class="nav-pill nav-hourly" href="hourly.html" aria-label="Hourly &amp; Tides">
            <span class="icon-bubble">üåä</span>
            <span class="label">Hourly &amp; Tides</span>
          </a>
          <a class="nav-pill nav-explore" href="explore.html" aria-label="Explore">
            <span class="icon-bubble">üß≠</span>
            <span class="label">Explore</span>
          </a>
          <a class="nav-pill nav-events" href="events.html" aria-label="Events">
            <span class="icon-bubble">üéâ</span>
            <span class="label">Events</span>
          </a>
        </div>
      </nav>

      <div class="phone-grid">
        <div class="phone">
          <div class="topline">
            <div class="badge">Capitola, CA</div>
            <span class="small-pill" id="local-time">Loading‚Ä¶</span>
          </div>
          <h2>Surf report and forecast ‚Üí</h2>
          <div class="card">
            <h3>
              Surf Report
              <span id="surf-summary">Live conditions loading‚Ä¶</span>
            </h3>
            <div class="data-row">
              <div class="data-pill">
                <small>Buoy Height</small>
                <strong id="wave-height">‚Äî</strong>
              </div>
              <div class="data-pill">
                <small>Peak Period</small>
                <strong id="wave-period">‚Äî</strong>
              </div>
              <div class="data-pill">
                <small>Wave Direction</small>
                <strong id="wave-direction">‚Äî</strong>
              </div>
            </div>
            <div class="data-row">
              <div class="data-pill">
                <small id="buoy-label">Buoy Station</small>
                <strong id="ndbc-wave">‚Äî</strong>
              </div>
              <div class="data-pill">
                <small>Wind</small>
                <strong id="wind">‚Äî</strong>
              </div>
              <div class="data-pill">
                <small>Direction</small>
                <strong id="wind-direction">‚Äî</strong>
              </div>
            </div>
          </div>
          <div class="section-card">
            <h3>
              Today <span class="small-pill" id="tide-station">NOAA 9413745</span>
            </h3>
            <div class="data-row">
              <div class="data-pill">
                <small>Current Tide</small>
                <strong id="current-tide">‚Äî</strong>
              </div>
              <div class="data-pill">
                <small>Next High</small>
                <strong id="next-high">‚Äî</strong>
              </div>
              <div class="data-pill">
                <small>Next Low</small>
                <strong id="next-low">‚Äî</strong>
              </div>
            </div>
            <p class="footer-note" id="data-updated">Gathering live surf + tide intel‚Ä¶</p>
          </div>
        </div>

        <div class="phone">
          <div class="topline">
            <div class="badge">Cam preview</div>
            <span class="small-pill">Beach cams</span>
          </div>
          <div class="illustration" aria-hidden="true" style="border-radius: 18px; min-height: 220px;"></div>
          <div class="section-card">
            <h3>Data sources (free & open)</h3>
            <div class="list">
              <div class="list-item">
                <span>NOAA CO‚ÄëOPS 9413745</span>
                <span class="small-pill">Tide predictions</span>
              </div>
              <div class="list-item">
                <span>CDIP ERDDAP stations 156 / 158</span>
                <span class="small-pill">Wave obs</span>
              </div>
              <div class="list-item">
                <span>NWS api.weather.gov</span>
                <span class="small-pill">Weather</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <p class="footer-note">Detailed surf snapshot aligned with the Capitola mockup.</p>
    </div>

    <script type="module">
      import { getTides, getWaves, getWeather } from './src/lib/getLocalData.js';

      const isNil = (val) => val === undefined || val === null || Number.isNaN(val);
      const toKnots = (mps) => {
        if (isNil(mps)) return null;
        return (mps * 1.94384).toFixed(1);
      };
      const cardinal = (degrees) => {
        if (degrees === undefined || degrees === null) return '‚Äî';
        const dirs = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
        const ix = Math.round(((degrees % 360) / 22.5)) % 16;
        return dirs[ix];
      };
      const setText = (id, text) => {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
      };
      const fmtLocal = (iso) =>
        iso
          ? new Date(iso).toLocaleString('en-US', {
              timeZone: 'America/Los_Angeles',
              hour: 'numeric',
              minute: '2-digit',
              weekday: 'short',
            })
          : '‚Äî';

      const updateTime = () => {
        const formatter = new Intl.DateTimeFormat('en-US', {
          timeZone: 'America/Los_Angeles',
          weekday: 'short',
          hour: 'numeric',
          minute: '2-digit',
        });
        setText('local-time', formatter.format(new Date()));
      };

      const describeSurf = (height, period) => {
        if (!height || !period) return 'Awaiting buoy data';
        const fair = height <= 4 ? 'Clean' : height <= 8 ? 'Fair' : 'Challenging';
        return `${height} ft @ ${period}s ¬∑ ${fair}`;
      };

      async function populate() {
        updateTime();
        try {
          const [tides, waves, weather] = await Promise.all([
            getTides().catch(() => null),
            getWaves().catch(() => null),
            getWeather().catch(() => null),
          ]);

          const buoy = waves?.latest;
          const waveHeight = buoy?.hs_ft ? buoy.hs_ft.toFixed(1) : null;
          const wavePeriod = buoy?.tp_s ? buoy.tp_s.toFixed(0) : buoy?.tz_s?.toFixed(0) || null;
          const waveDir = buoy?.dp_deg_true ? cardinal(buoy.dp_deg_true) : '‚Äî';
          setText('wave-height', waveHeight ? `${waveHeight} ft` : '‚Äî');
          setText('wave-period', wavePeriod ? `${wavePeriod}s` : '‚Äî');
          setText('wave-direction', waveDir);
          setText('ndbc-wave', buoy?.station_name ? `${buoy.station_name} (${buoy.station_id})` : '‚Äî');
          setText('buoy-label', 'Buoy Station');

          const windMph = weather?.current?.wind_mph || weather?.hourly?.[0]?.wind_mph;
          const windDir = weather?.current?.wind_dir_deg || weather?.hourly?.[0]?.wind_dir;
          setText('wind', windMph ? `${windMph.toFixed(1)} mph` : 'Calm');
          setText('wind-direction', windDir ? cardinal(windDir) : '‚Äî');
          setText('surf-summary', describeSurf(waveHeight, wavePeriod));

          const observations = tides?.observations || [];
          const currentTide = observations[observations.length - 1];
          setText('current-tide', currentTide ? `${currentTide.ft.toFixed(2)} ft @ ${fmtLocal(currentTide.t)}` : '‚Äî');
          const nextHigh = tides?.next_extrema?.find((e) => e.type === 'HIGH');
          const nextLow = tides?.next_extrema?.find((e) => e.type === 'LOW');
          setText('next-high', nextHigh ? `${nextHigh.ft.toFixed(2)} ft @ ${fmtLocal(nextHigh.t)}` : '‚Äî');
          setText('next-low', nextLow ? `${nextLow.ft.toFixed(2)} ft @ ${fmtLocal(nextLow.t)}` : '‚Äî');

          const updatedPieces = [];
          if (tides?.generated_at) updatedPieces.push(`Tides ${fmtLocal(tides.generated_at)}`);
          if (waves?.generated_at) updatedPieces.push(`Waves ${fmtLocal(waves.generated_at)}`);
          if (weather?.generated_at) updatedPieces.push(`Weather ${fmtLocal(weather.generated_at)}`);
          setText('data-updated', updatedPieces.length ? `Updated ${updatedPieces.join(' ¬∑ ')}` : 'Waiting for updates');
        } catch (err) {
          setText('surf-summary', 'Unable to load live data');
          setText('data-updated', err.message);
        }
      }

      populate();
      setInterval(populate, 15 * 60 * 1000);
    </script>
  </body>
</html>
