<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Capitola Surf ‚Äì Hourly</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="page">
      <nav>
        <div class="logo">Capitola Companion</div>
        <div class="links">
          <a class="nav-pill nav-welcome" href="index.html" aria-label="Welcome">
            <span class="icon-bubble">üèÑ‚Äç‚ôÄÔ∏è</span>
            <span class="label">Welcome</span>
          </a>
          <a class="nav-pill nav-report" href="report.html" aria-label="Surf Report">
            <span class="icon-bubble">üì°</span>
            <span class="label">Surf Report</span>
          </a>
          <a class="nav-pill nav-hourly active" href="hourly.html" aria-label="Hourly &amp; Tides" aria-current="page">
            <span class="icon-bubble">üåä</span>
            <span class="label">Hourly &amp; Tides</span>
          </a>
          <a class="nav-pill nav-explore" href="explore.html" aria-label="Explore">
            <span class="icon-bubble">üß≠</span>
            <span class="label">Explore</span>
          </a>
          <a class="nav-pill nav-events" href="events.html" aria-label="Events">
            <span class="icon-bubble">üéâ</span>
            <span class="label">Events</span>
          </a>
        </div>
      </nav>

      <div class="phone-grid">
        <div class="phone">
          <div class="topline">
            <div class="badge">Capitola Jetty</div>
            <span class="small-pill" id="hourly-updated">Live updates</span>
          </div>
          <h2 id="current-summary">Forecast: loading‚Ä¶</h2>
          <div class="data-row">
            <div class="data-pill"><small>Surf</small><strong id="current-surf">‚Äî</strong></div>
            <div class="data-pill"><small>Feels like</small><strong id="current-temp">‚Äî</strong></div>
            <div class="data-pill"><small>Wind</small><strong id="current-wind">‚Äî</strong></div>
          </div>
          <div class="section-card">
            <h3>Hourly forecast (next 12 hrs)</h3>
            <div class="timeline" id="hourly-forecast"></div>
          </div>
        </div>

        <div class="phone">
          <div class="topline">
            <div class="badge">Tide forecast</div>
            <span class="small-pill">NOAA predictions</span>
          </div>
          <div class="section-card">
            <h3>New Brighton State Beach <span class="small-pill" id="tide-updated">‚Äî</span></h3>
            <div class="timeline" id="tide-forecast"></div>
          </div>
          <div class="section-card">
            <h3>Feels like</h3>
            <div class="data-row">
              <div class="data-pill"><small>Temperature</small><strong id="temp-now">‚Äî</strong></div>
              <div class="data-pill"><small>Precip</small><strong id="precip-now">‚Äî</strong></div>
              <div class="data-pill"><small>Wind</small><strong id="wind-now">‚Äî</strong></div>
            </div>
          </div>
        </div>
      </div>

      <p class="footer-note">Hour-by-hour surf and tide cues designed after the mockup panels.</p>
    </div>

    <script type="module">
      import { getTides, getWaves, getWeather } from './src/lib/getLocalData.js';

      const cardinal = (degrees) => {
        if (degrees === undefined || degrees === null) return '‚Äî';
        const dirs = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
        const ix = Math.round(((degrees % 360) / 22.5)) % 16;
        return dirs[ix];
      };

      const fmtHour = (iso) =>
        new Date(iso).toLocaleString('en-US', {
          hour: 'numeric',
          hour12: true,
          timeZone: 'America/Los_Angeles',
        });

      const fmtTemp = (value) => (value !== undefined && value !== null ? `${Number(value).toFixed(0)}¬∫F` : '‚Äî');

      function renderHourly(hourly = []) {
        const container = document.getElementById('hourly-forecast');
        if (!container) return;
        container.innerHTML = '';
        const maxTemp = Math.max(...hourly.map((h) => h.temp_f || 0), 60);
        hourly.slice(0, 12).forEach((period) => {
          const bar = document.createElement('div');
          const height = Math.max(40, ((period.temp_f || maxTemp) / maxTemp) * 140);
          bar.className = 'bar';
          bar.style.height = `${height}px`;
          bar.textContent = fmtHour(period.t);

          const wrapper = document.createElement('div');
          wrapper.appendChild(bar);
          const temp = document.createElement('small');
          temp.textContent = `${fmtTemp(period.temp_f)} ¬∑ ${period.shortForecast || '‚Äî'}`;
          wrapper.appendChild(temp);
          container.appendChild(wrapper);
        });
      }

      function renderTides(predictions = [], nextExtrema = []) {
        const container = document.getElementById('tide-forecast');
        if (!container) return;
        container.innerHTML = '';
        const now = Date.now();
        const upcoming = predictions.filter((p) => new Date(p.t).getTime() > now).slice(0, 6);
        if (!upcoming.length) {
          container.textContent = 'Tide predictions unavailable';
          return;
        }
        const values = upcoming.map((p) => p.ft);
        const max = Math.max(...values);
        const min = Math.min(...values);
        const span = Math.max(1, max - min);

        upcoming.forEach((p) => {
          const bar = document.createElement('div');
          const normalized = (p.ft - min) / span;
          const height = 60 + normalized * 120;
          bar.className = 'bar';
          bar.style.height = `${height}px`;
          bar.style.background = 'linear-gradient(180deg, rgba(79,178,255,0.18), #4fb2ff)';
          bar.textContent = p.ft.toFixed(2);

          const wrapper = document.createElement('div');
          wrapper.appendChild(bar);
          const label = document.createElement('small');
          const match = nextExtrema.find((e) => e.t === p.t);
          label.textContent = match ? `${fmtHour(p.t)} ${match.type}` : fmtHour(p.t);
          wrapper.appendChild(label);
          container.appendChild(wrapper);
        });
      }

      async function populate() {
        try {
          const [tides, waves, weather] = await Promise.all([getTides(), getWaves(), getWeather()]);
          const buoy = waves?.latest;
          const waveHeight = buoy?.hs_ft ? `${buoy.hs_ft.toFixed(1)} ft` : '‚Äî';
          const wavePeriod = buoy?.tp_s ? `${buoy.tp_s.toFixed(0)}s` : buoy?.tz_s ? `${buoy.tz_s.toFixed(0)}s` : '‚Äî';
          const waveDir = buoy?.dp_deg_true ? cardinal(buoy.dp_deg_true) : '‚Äî';
          document.getElementById('current-surf').textContent = `${waveHeight} @ ${wavePeriod} ${waveDir}`;

          const currentTemp = weather?.current?.temp_f || weather?.hourly?.[0]?.temp_f;
          document.getElementById('current-temp').textContent = fmtTemp(currentTemp);
          const windMph = weather?.current?.wind_mph || weather?.hourly?.[0]?.wind_mph;
          const windDir = weather?.current?.wind_dir_deg || weather?.hourly?.[0]?.wind_dir;
          document.getElementById('current-wind').textContent = windMph ? `${windMph.toFixed(1)} mph` : 'Calm';
          document.getElementById('wind-now').textContent = windDir ? `${cardinal(windDir)} ${windMph?.toFixed(1) || ''} mph` : '‚Äî';

          renderHourly(weather?.hourly);
          renderTides(tides?.predictions, tides?.next_extrema || []);

          const precip = weather?.hourly?.[0]?.precip_prob;
          document.getElementById('precip-now').textContent =
            precip !== null && precip !== undefined ? `${precip.toFixed(0)}%` : '‚Äî';
          document.getElementById('temp-now').textContent = fmtTemp(currentTemp);

          const updatedTime = weather?.generated_at
            ? new Date(weather.generated_at).toLocaleTimeString('en-US', { timeZone: 'America/Los_Angeles' })
            : '‚Äî';
          document.getElementById('hourly-updated').textContent = `Updated ${updatedTime}`;

          const tideUpdated = tides?.generated_at
            ? new Date(tides.generated_at).toLocaleTimeString('en-US', { timeZone: 'America/Los_Angeles' })
            : '‚Äî';
          document.getElementById('tide-updated').textContent = tideUpdated;

          document.getElementById('current-summary').textContent = `Forecast: ${waveHeight} ¬∑ ${fmtTemp(currentTemp)}`;
        } catch (err) {
          document.getElementById('hourly-forecast').textContent = 'Unable to load hourly data';
          document.getElementById('tide-forecast').textContent = 'Unable to load tide data';
          document.getElementById('hourly-updated').textContent = err.message;
        }
      }

      populate();
      setInterval(populate, 15 * 60 * 1000);
    </script>
  </body>
</html>
